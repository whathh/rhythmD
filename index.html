<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Rhythm Trainer â€“ H-System & Fractions</title>
<style>
  body { font-family: Arial,sans-serif; background:#f9f9f9; text-align:center; margin:20px; }
  h1 { margin-bottom:10px; }
  #baseNote { font-size:80px; margin-bottom:10px; }
  #notes { display:grid; grid-template-columns:repeat(10,1fr); gap:12px; max-width:90vw; margin:0 auto 15px; }
  .note { font-size:40px; user-select:none; }
  .answer { width:80px; padding:6px; font-size:20px; text-align:center; border-radius:4px; border:1.5px solid #ccc; transition:border-color 0.3s; }
  .answer:focus { border-color:#0b76ef; outline:none; }
  .correct { color:black; border-color:#2d8f2d !important; }
  .wrong { color:red; border-color:red !important; }
  .correctAnswer { font-size:14px; margin-top:6px; user-select:none; }
  #controls { margin-bottom:15px; }
  #timer { font-size:24px; font-weight:bold; margin-bottom:15px; user-select:none; }
  #result,#score { font-size:18px; margin-top:8px; user-select:none; }
  button { background-color:#0b76ef; color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; margin:0 10px; font-size:16px; user-select:none; }
  button:hover { background-color:#095aba; }
</style>
</head>
<body>

<h1>ğŸµ Rhythm Trainer</h1>
<div id="baseNote" title="Base note (quarter = 1 beat)"></div>
<div id="timer">Timer: 0.00 s</div>
<div id="notes"></div>

<div id="controls">
  <button id="startBtn">Start New (N)</button>
  <button id="submitBtn">Submit (Enter)</button>
</div>

<div id="result"></div>
<div id="score"></div>

<script>
const REGULAR_NOTES = [
  { sym:'ğ…', dur:4 }, { sym:'ğ…', dur:2 }, { sym:'ğ…Ÿ', dur:1 },
  { sym:'ğ… ', dur:0.5 }, { sym:'ğ…¡', dur:0.25 }, { sym:'ğ…¢', dur:0.125 },
  { sym:'ğ…£', dur:0.0625 }
];
const DOTTED_NOTES = [
  { sym:'ğ…â€¢', dur:6 }, { sym:'ğ…â€¢', dur:3 }, { sym:'ğ…Ÿâ€¢', dur:1.5 },
  { sym:'ğ… â€¢', dur:0.75 }, { sym:'ğ…¡â€¢', dur:0.375 }
];
const BASE_NOTES = [
  { sym:'ğ…Ÿ', dur:1 }, { sym:'ğ… ', dur:0.5 }, { sym:'ğ…¡', dur:0.25 },
  { sym:'ğ…¢', dur:0.125 }, { sym:'ğ…£', dur:0.0625 }
];
const ALLOWED_BASE_FRACTIONS = [1.5,1.25,1.125,1,0.75,0.5,0.375,0.25,0.125,0.0625];
const COUNT = 20;

let baseNote=null, questionNotes=[], startTime=null, timerInterval=null;
let highScore = Number(localStorage.getItem('rhythmHighScore')||0);
let bestTime = Number(localStorage.getItem('rhythmBestTime')||0);

const baseNoteDiv=document.getElementById('baseNote');
const notesDiv=document.getElementById('notes');
const timerDiv=document.getElementById('timer');
const resultDiv=document.getElementById('result');
const scoreDiv=document.getElementById('score');
const startBtn=document.getElementById('startBtn');
const submitBtn=document.getElementById('submitBtn');

// ---------------- H-SYSTEM & FRACTION UTILITIES ----------------
function durationToH(noteDuration){
    if(!baseNote) return "Error";
    const ratio = noteDuration / baseNote.dur;
    const count = nearestAllowedAnswer(ratio);
    return `${Math.round(count)}h`; // always numeric H, e.g., 4h
}

function parseHPattern(str){
    str = str.trim().toLowerCase();
    if(!str) return NaN;

    // Case 1: numeric H, e.g., "4h"
    const match = str.match(/^(\d+)h$/i);
    if(match) return parseInt(match[1]);

    // Case 2: repeated 'h', e.g., "hhhh"
    if(/^[h\s]+$/i.test(str)) return (str.match(/h/gi)||[]).length;

    return NaN;
}

function parseAnswer(inputStr){
    inputStr = inputStr.trim();
    const hVal = parseHPattern(inputStr);
    if(!isNaN(hVal)) return hVal;
    if(inputStr.includes('/')){
        const parts = inputStr.split('/');
        if(parts.length===2){
            const numerator=parseFloat(parts[0]);
            const denominator=parseFloat(parts[1]);
            if(!isNaN(numerator)&&!isNaN(denominator)&&denominator!==0) return numerator/denominator;
        }
        return NaN;
    }
    return parseFloat(inputStr);
}

function decimalToFraction(value,maxDenominator=64){
    if(value===0) return "0";
    const sign=value<0?"-":"";
    value=Math.abs(value);
    let bestN=1, bestD=1, bestError=Math.abs(value-1);
    for(let d=1;d<=maxDenominator;d++){
        let n=Math.round(value*d);
        let err=Math.abs(value-n/d);
        if(err<bestError){ bestN=n; bestD=d; bestError=err; }
    }
    function gcd(a,b){return b?gcd(b,a%b):a;}
    let g=gcd(bestN,bestD); bestN/=g; bestD/=g;
    if(bestN>=bestD){ let w=Math.floor(bestN/bestD); let r=bestN%bestD; return r===0?sign+w:sign+w+" "+r+"/"+bestD; }
    return sign+bestN+"/"+bestD;
}

function nearestAllowedAnswer(val){
    let bestDiff=Infinity, bestVal=val;
    const maxMult=Math.ceil(val)+1;
    for(let mult=1;mult<=maxMult;mult++){
        for(const frac of ALLOWED_BASE_FRACTIONS){
            const candidate=mult*frac;
            const diff=Math.abs(val-candidate);
            if(diff<bestDiff){ bestDiff=diff; bestVal=candidate; }
        }
    }
    return bestVal;
}
// ---------------------------------------------------------------

function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function pickRandomBaseNote(){ return BASE_NOTES[Math.floor(Math.random()*BASE_NOTES.length)]; }
function filterNotesByMaxAnswer(notes,baseDur,maxAnswer){ return notes.filter(n=>(n.dur/baseDur)<=maxAnswer); }

function startQuiz(){
    if(timerInterval) clearInterval(timerInterval);
    startTime=performance.now();
    timerDiv.textContent="Timer: 0.00 s";

    baseNote=pickRandomBaseNote();
    baseNoteDiv.textContent=baseNote.sym;
    baseNoteDiv.title=`Base note duration: ${baseNote.dur} beats (base note = 1 second)`;

    const MAX_ANSWER=16;
    const filteredRegular=filterNotesByMaxAnswer(REGULAR_NOTES,baseNote.dur,MAX_ANSWER);
    const filteredDotted=filterNotesByMaxAnswer(DOTTED_NOTES,baseNote.dur,MAX_ANSWER);
    const safeRegular=filteredRegular.length>=(COUNT-6)?filteredRegular:REGULAR_NOTES;
    const safeDotted=filteredDotted.length>=2?filteredDotted:DOTTED_NOTES;

    const dottedCount=2+Math.floor(Math.random()*5);
    const selectedDotted=[]; for(let i=0;i<dottedCount;i++) selectedDotted.push(safeDotted[Math.floor(Math.random()*safeDotted.length)]);
    const regularCount=COUNT-dottedCount;
    const selectedRegular=[]; for(let i=0;i<regularCount;i++) selectedRegular.push(safeRegular[Math.floor(Math.random()*safeRegular.length)]);
    questionNotes=shuffleArray(selectedDotted.concat(selectedRegular));

    notesDiv.innerHTML="";
    for(let i=0;i<COUNT;i++){
        const q=questionNotes[i];
        const container=document.createElement('div');
        container.style.display='flex'; container.style.flexDirection='column'; container.style.alignItems='center';
        const noteLabel=document.createElement('div'); noteLabel.className='note'; noteLabel.textContent=q.sym;
        const input=document.createElement('input'); input.type='text'; input.className='answer';
        const correctAnsDiv=document.createElement('div'); correctAnsDiv.className='correctAnswer';
        container.appendChild(noteLabel); container.appendChild(input); container.appendChild(correctAnsDiv);
        notesDiv.appendChild(container);
    }

    resultDiv.textContent="";
    updateScore();

    timerInterval=setInterval(()=>{ const elapsed=(performance.now()-startTime)/1000; timerDiv.textContent=`Timer: ${elapsed.toFixed(2)} s`; },100);
}

function checkAnswers(){
    if(!startTime) return;
    if(timerInterval) clearInterval(timerInterval);

    const inputs=document.querySelectorAll('.answer');
    const containers=notesDiv.children;
    let correct=0; const tolerance=0.01;

    inputs.forEach((input,idx)=>{
        const expectedRaw=questionNotes[idx].dur/baseNote.dur;
        const expected=nearestAllowedAnswer(expectedRaw);
        const val=parseAnswer(input.value);
        const correctAnsDiv=containers[idx].querySelector('.correctAnswer');
        correctAnsDiv.textContent=`Answer: ${decimalToFraction(expected)} | H: ${durationToH(questionNotes[idx].dur)}`;

        if(!isNaN(val)&&Math.abs(val-expected)<=tolerance){
            input.classList.remove('wrong'); input.classList.add('correct'); correctAnsDiv.style.color='black';
        } else {
            input.classList.remove('correct'); input.classList.add('wrong'); correctAnsDiv.style.color='red';
        }
    });

    const elapsed=(performance.now()-startTime)/1000;
    resultDiv.textContent=`Correct: ${correct} / ${COUNT} | Total Time: ${elapsed.toFixed(2)} s`;

    if(correct>highScore){ highScore=correct; localStorage.setItem('rhythmHighScore',highScore); }
    if(correct===COUNT&&(bestTime===0||elapsed<bestTime)){ bestTime=elapsed; localStorage.setItem('rhythmBestTime',bestTime); }
    updateScore();
}

function updateScore(){ scoreDiv.textContent=`High Score: ${highScore} | Best Perfect Time: ${bestTime>0?bestTime.toFixed(2)+' s':'--'}`; }

document.addEventListener('keydown',e=>{
    if(e.key==='Enter') checkAnswers();
    else if(e.key.toLowerCase()==='n') startQuiz();
});
startBtn.addEventListener('click',startQuiz);
submitBtn.addEventListener('click',checkAnswers);

startQuiz();
</script>
</body>
</html>
